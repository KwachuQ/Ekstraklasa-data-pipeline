{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.10.11", "generated_at": "2025-10-29T10:15:02.973102Z", "invocation_id": "3aa52a1d-6efc-4aa5-866d-b4f4137d8275", "invocation_started_at": "2025-10-29T10:15:00.981883Z", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2025-10-29T10:15:02.802467Z", "completed_at": "2025-10-29T10:15:02.817752Z"}, {"name": "execute", "started_at": "2025-10-29T10:15:02.818763Z", "completed_at": "2025-10-29T10:15:02.946658Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.14755606651306152, "adapter_response": {"_message": "SELECT 95", "code": "SELECT", "rows_affected": 95}, "message": "SELECT 95", "failures": null, "unique_id": "model.sofascore_pipeline.mart_match_predictions", "compiled": true, "compiled_code": "\n\nwith team_home_stats as (\n    select\n        fm.season_id,\n        fm.home_team_id as team_id,\n        count(*) as home_matches,\n        avg(fm.home_score) as avg_home_goals_scored,\n        avg(fm.away_score) as avg_home_goals_conceded,\n        avg(coalesce(ftm.stat_expectedgoals, 0)) as avg_home_xg,\n        avg(coalesce(ftm.stat_shotsongoal, 0)) as avg_home_shots_on_target,\n        avg(coalesce(ftm.stat_ballpossession, 0)) as avg_home_possession,\n        sum(case when fm.winner_code = 1 then 1 else 0 end)::numeric / nullif(count(*), 0) as home_win_rate,\n        sum(case when fm.winner_code = 2 then 1 else 0 end)::numeric / nullif(count(*), 0) as home_draw_rate\n    from \"dwh\".\"silver\".\"fact_match\" fm\n    left join \"dwh\".\"silver\".\"fact_team_match\" ftm \n        on fm.match_id = ftm.match_id \n        and fm.home_team_id = ftm.team_id \n        and ftm.period = 'ALL'\n    where fm.status_type = 'finished'\n    group by fm.season_id, fm.home_team_id\n),\nteam_away_stats as (\n    select\n        fm.season_id,\n        fm.away_team_id as team_id,\n        count(*) as away_matches,\n        avg(fm.away_score) as avg_away_goals_scored,\n        avg(fm.home_score) as avg_away_goals_conceded,\n        avg(coalesce(ftm.stat_expectedgoals, 0)) as avg_away_xg,\n        avg(coalesce(ftm.stat_shotsongoal, 0)) as avg_away_shots_on_target,\n        avg(coalesce(ftm.stat_ballpossession, 0)) as avg_away_possession,\n        sum(case when fm.winner_code = 3 then 1 else 0 end)::numeric / nullif(count(*), 0) as away_win_rate,\n        sum(case when fm.winner_code = 2 then 1 else 0 end)::numeric / nullif(count(*), 0) as away_draw_rate\n    from \"dwh\".\"silver\".\"fact_match\" fm\n    left join \"dwh\".\"silver\".\"fact_team_match\" ftm \n        on fm.match_id = ftm.match_id \n        and fm.away_team_id = ftm.team_id \n        and ftm.period = 'ALL'\n    where fm.status_type = 'finished'\n    group by fm.season_id, fm.away_team_id\n),\nteam_form as (\n    select\n        team_id,\n        season_id,\n        points_last_5,\n        wins_last_5,\n        goals_for_last_5,\n        goals_against_last_5\n    from \"dwh\".\"gold\".\"mart_team_form\"\n),\nmatches_to_predict as (\n    select\n        fm.match_id,\n        fm.match_date,\n        fm.season_id,\n        fm.season_name,\n        fm.season_year,\n        fm.home_team_id,\n        fm.home_team_name,\n        fm.away_team_id,\n        fm.away_team_name,\n        fm.tournament_id,\n        fm.tournament_name,\n        fm.status_type,\n        fm.home_score,\n        fm.away_score,\n        fm.winner_code\n    from \"dwh\".\"silver\".\"fact_match\" fm\n    where fm.status_type = 'finished'\n        and fm.match_date >= current_date - interval '90 days'  -- Last 90 days for validation\n),\nbase_predictions as (\n    select\n        mp.match_id,\n        mp.match_date,\n        mp.season_id,\n        mp.season_name,\n        mp.season_year,\n        mp.home_team_id,\n        mp.home_team_name,\n        mp.away_team_id,\n        mp.away_team_name,\n        mp.tournament_name,\n        mp.status_type,\n        mp.home_score,\n        mp.away_score,\n        mp.winner_code,\n        \n        -- Home team features\n        coalesce(hs.avg_home_goals_scored, 0) as home_avg_goals_scored_home,\n        coalesce(hs.avg_home_goals_conceded, 0) as home_avg_goals_conceded_home,\n        coalesce(hs.avg_home_xg, 0) as home_avg_xg_home,\n        coalesce(hs.avg_home_shots_on_target, 0) as home_avg_shots_on_target_home,\n        coalesce(hs.avg_home_possession, 0) as home_avg_possession_home,\n        coalesce(hs.home_win_rate, 0) as home_win_rate_home,\n        coalesce(hs.home_draw_rate, 0) as home_draw_rate_home,\n        coalesce(hf.points_last_5, 0) as home_points_last_5,\n        coalesce(hf.wins_last_5, 0) as home_wins_last_5,\n        coalesce(hf.goals_for_last_5, 0) as home_goals_for_last_5,\n        coalesce(hf.goals_against_last_5, 0) as home_goals_against_last_5,\n        \n        -- Away team features\n        coalesce(as_.avg_away_goals_scored, 0) as away_avg_goals_scored_away,\n        coalesce(as_.avg_away_goals_conceded, 0) as away_avg_goals_conceded_away,\n        coalesce(as_.avg_away_xg, 0) as away_avg_xg_away,\n        coalesce(as_.avg_away_shots_on_target, 0) as away_avg_shots_on_target_away,\n        coalesce(as_.avg_away_possession, 0) as away_avg_possession_away,\n        coalesce(as_.away_win_rate, 0) as away_win_rate_away,\n        coalesce(as_.away_draw_rate, 0) as away_draw_rate_away,\n        coalesce(af.points_last_5, 0) as away_points_last_5,\n        coalesce(af.wins_last_5, 0) as away_wins_last_5,\n        coalesce(af.goals_for_last_5, 0) as away_goals_for_last_5,\n        coalesce(af.goals_against_last_5, 0) as away_goals_against_last_5,\n        \n        -- Raw probability components\n        coalesce(hs.home_win_rate, 0.33) as raw_home_win_rate,\n        coalesce(as_.away_win_rate, 0.33) as raw_away_win_rate,\n        coalesce(hs.home_draw_rate, 0.33) as raw_home_draw_rate,\n        coalesce(as_.away_draw_rate, 0.33) as raw_away_draw_rate\n        \n    from matches_to_predict mp\n    left join team_home_stats hs \n        on mp.home_team_id = hs.team_id \n        and mp.season_id = hs.season_id\n    left join team_away_stats as_ \n        on mp.away_team_id = as_.team_id \n        and mp.season_id = as_.season_id\n    left join team_form hf \n        on mp.home_team_id = hf.team_id \n        and mp.season_id = hf.season_id\n    left join team_form af \n        on mp.away_team_id = af.team_id \n        and mp.season_id = af.season_id\n),\nnormalized_predictions as (\n    select\n        *,\n        -- Calculate predicted goals\n        round((home_avg_goals_scored_home + away_avg_goals_conceded_away) / 2, 2) as predicted_home_goals,\n        round((away_avg_goals_scored_away + home_avg_goals_conceded_home) / 2, 2) as predicted_away_goals,\n        round((home_avg_xg_home + away_avg_xg_away) / 2, 2) as predicted_total_xg,\n        \n        -- Combine win rates and draw rates with weights\n        (raw_home_win_rate * 0.6 + (1 - raw_away_win_rate - raw_away_draw_rate) * 0.4) as combined_home_prob,\n        (raw_away_win_rate * 0.6 + (1 - raw_home_win_rate - raw_home_draw_rate) * 0.4) as combined_away_prob,\n        (raw_home_draw_rate * 0.5 + raw_away_draw_rate * 0.5) as combined_draw_prob\n    from base_predictions\n),\nfinal_normalized as (\n    select\n        *,\n        -- Normalize to ensure probabilities sum to 1\n        combined_home_prob / nullif(combined_home_prob + combined_away_prob + combined_draw_prob, 0) as norm_home_prob,\n        combined_draw_prob / nullif(combined_home_prob + combined_away_prob + combined_draw_prob, 0) as norm_draw_prob,\n        combined_away_prob / nullif(combined_home_prob + combined_away_prob + combined_draw_prob, 0) as norm_away_prob\n    from normalized_predictions\n)\nselect\n    match_id,\n    match_date,\n    season_id,\n    season_name,\n    season_year,\n    home_team_id,\n    home_team_name,\n    away_team_id,\n    away_team_name,\n    tournament_name,\n    \n    -- Home team features\n    home_avg_goals_scored_home,\n    home_avg_goals_conceded_home,\n    home_avg_xg_home,\n    home_avg_shots_on_target_home,\n    home_avg_possession_home,\n    home_win_rate_home,\n    home_points_last_5,\n    home_wins_last_5,\n    home_goals_for_last_5,\n    home_goals_against_last_5,\n    \n    -- Away team features\n    away_avg_goals_scored_away,\n    away_avg_goals_conceded_away,\n    away_avg_xg_away,\n    away_avg_shots_on_target_away,\n    away_avg_possession_away,\n    away_win_rate_away,\n    away_points_last_5,\n    away_wins_last_5,\n    away_goals_for_last_5,\n    away_goals_against_last_5,\n    \n    -- Predicted scores\n    predicted_home_goals,\n    predicted_away_goals,\n    predicted_total_xg,\n    \n    -- Match outlook\n    case\n        when norm_home_prob > norm_away_prob + 0.15 then 'HOME_FAVORITE'\n        when norm_away_prob > norm_home_prob + 0.15 then 'AWAY_FAVORITE'\n        else 'BALANCED'\n    end as match_outlook,\n    \n    -- Normalized probabilities (guaranteed to sum to 100%)\n    round(coalesce(norm_home_prob, 0.33) * 100, 1) as home_win_probability,\n    round(coalesce(norm_draw_prob, 0.33) * 100, 1) as draw_probability,\n    round(coalesce(norm_away_prob, 0.33) * 100, 1) as away_win_probability,\n    \n    -- Fair odds (inverse of probability)\n    case \n        when norm_home_prob > 0.01 then round(1 / norm_home_prob, 2)\n        else 99.99\n    end as home_win_fair_odds,\n    case \n        when norm_draw_prob > 0.01 then round(1 / norm_draw_prob, 2)\n        else 99.99\n    end as draw_fair_odds,\n    case \n        when norm_away_prob > 0.01 then round(1 / norm_away_prob, 2)\n        else 99.99\n    end as away_win_fair_odds,\n    \n    -- Actual results for validation (derived from actual scores, not winner_code)\n    home_score as actual_home_score,\n    away_score as actual_away_score,\n    case \n        when home_score > away_score then 'HOME_WIN'\n        when home_score < away_score then 'AWAY_WIN'\n        when home_score = away_score then 'DRAW'\n        else 'UNKNOWN'\n    end as actual_result,\n    \n    -- Prediction accuracy metrics (also based on actual scores)\n    case \n        when (norm_home_prob > norm_draw_prob and norm_home_prob > norm_away_prob and home_score > away_score) then true\n        when (norm_draw_prob > norm_home_prob and norm_draw_prob > norm_away_prob and home_score = away_score) then true\n        when (norm_away_prob > norm_home_prob and norm_away_prob > norm_draw_prob and home_score < away_score) then true\n        else false\n    end as prediction_correct,\n    \n    abs(predicted_home_goals - home_score) as home_goals_error,\n    abs(predicted_away_goals - away_score) as away_goals_error\n\nfrom final_normalized\norder by match_date desc", "relation_name": "\"dwh\".\"gold\".\"mart_match_predictions\"", "batch_results": null}], "elapsed_time": 0.3342733383178711, "args": {"partial_parse": true, "profiles_dir": "/opt/dbt/profiles", "upload_to_artifacts_ingest_api": false, "defer": false, "write_json": true, "select": ["mart_match_predictions"], "quiet": false, "use_fast_test_edges": false, "require_resource_names_without_spaces": true, "favor_state": false, "print": true, "log_path": "/opt/dbt/project/logs", "log_level_file": "debug", "which": "run", "introspect": true, "exclude": [], "require_nested_cumulative_type_params": false, "send_anonymous_usage_stats": true, "use_colors": true, "require_batched_execution_for_custom_microbatch_strategy": false, "empty": false, "source_freshness_run_project_hooks": true, "strict_mode": false, "use_colors_file": true, "vars": {}, "show_all_deprecations": false, "validate_macro_args": false, "indirect_selection": "eager", "log_format": "default", "require_yaml_configuration_for_mf_time_spines": false, "require_generic_test_arguments_property": true, "populate_cache": true, "macro_debugging": false, "project_dir": "/opt/dbt/project", "skip_nodes_if_on_run_start_fails": false, "require_explicit_package_overrides_for_builtin_materializations": true, "partial_parse_file_diff": true, "require_all_warnings_handled_by_warn_error": false, "printer_width": 80, "log_level": "info", "warn_error_options": {"error": [], "warn": [], "silence": []}, "cache_selected_only": false, "log_file_max_bytes": 10485760, "log_format_file": "debug", "invocation_command": "dbt run -s mart_match_predictions", "state_modified_compare_more_unrendered_values": false, "state_modified_compare_vars": false, "version_check": true, "show_resource_report": false, "static_parser": true}}